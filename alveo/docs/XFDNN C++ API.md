# ML-Suite C++ APIs to run inference on a single image

The C++ APIs provide users an easy way to deploy Deep CNNs on FPGA.

## 1. Prerequisites

**XFDNN compiler outputs**
  - `compiler JSON` : File containing low level hardware instructions.
  - `model_data.h5` : File containing preprocessed floating point data (weights/biases).
  - `quantizer JSON` : File containing scaling factors for each layer in the corresponding network.

## 2. Header Files

Any of the XFDNN C++ APIs can be called by including following header files available at `<MLSuite>/vai/dpuv1/rt/xdnn_cpp/`

```c++
#include "xblas.h"
#include "xdnn.h"
```

## 3. Create Handle

Programs the hardware acceleration engine and initializes communication with the FPGA. Loads the kernel from xclbin and creates a kernel object.

**Syntax**
```c++
// Create FPGA handle
XBLASHandle *handle = NULL;

int xblasCreate(
               XBLASHandle *&handle,
               const char *xclbin,
               const char *kernelName,
               int deviceIdx
             );
```
**Parameters**

***Inputs***
 - `xclbin`		: Path to the design bitstream to be loaded.
 - `kernel`   : Name of the kernel in xclbin. Always use `kernelSxdnn_0` .
 - `deviceIdx` : ID of the device to create handles for.
 - `handle` : Instance of the class `XBLASHandle` which is filled inside `xblasCreate()` API. One handle per device.

***Outputs***
 - Returns the error status. Returns `0` upon successful execution or `-1` otherwise.

## 4. Initialize `XDNNScriptExecutor` and Load Weights/Biases

Load weights, biases and quantization parameters to FPGA DDR using `model_data.h5` file generated by compiler. Programs the XFDNN IP using low level instructions generated by compiler.

**Syntax**
```c++
void* XDNNMakeScriptExecutorAndLoadWeights(
                                          XBLASHandle **handlePtrs,
                                          int numHandles,
                                          char *weightsPath,
                                          char *xdnnNetFile,
                                          char *fpgaCfgFile,
                                          float scaleB,
                                          unsigned int cuMask
                                        );
```

**Parameters**

***Inputs***
 - `handlePtrs` : Handles created by `xblasCreate()` API.
 - `numHandles` : Total number of handles created. One handle per device.
 - `weightsPath` : Path to `model_data.h5` file generated by compiler.
 - `xdnnNetFile` : Path to compiler `JSON`.
 - `fpgaCfgFile` :  Path to quantizer `JSON`.
 - `scaleB` : Activation scaling value.
 - `cuMask` : ID of the PE (Process Engine).

***Outputs***
 - Returns an object of the class `XDNNScriptExecutor`.

## 5. Load I/O Nodes

Loads input and output nodes.

**Syntax**
```c++
// Create input Container
std::unordered_map <std::string, std::vector<const float*> > input_ptrs;

// Create output Container
std::unordered_map <std::string, std::vector<float*> > output_ptrs;

int loadIONodes(
  char *netcfg,
  const std::unordered_map <std::string, std::vector< const float*> > & input_ptrs,
  std::unordered_map< std::string, std::vector<float*> > & output_ptrs
);
```

**Parameters**

***Inputs***
 - `netcfg` : Path to compiler `JSON`.
 - `input_ptrs` : Reference to the map containing the input data for inference.
 - `output_ptrs` : Reference to the map which has to be filled with output data.

***Outputs***
 - Returns the error status. Returns `0` upon successful execution or `1` otherwise.

## 6. Prepare Input

Loads image and performs resize and mean subtraction.

**Syntax**
```c++
// Read input image
cv::Mat in_frame = cv::imread(image_path, 1);

// Create float pointer
float *data_ptr = NULL;

int prepareInputData(
                    cv::Mat &in_frame,
                    int img_h,
                    int img_w,
                    int img_depth,
                    float *data_ptr,
                    int *act_img_h,
                    int *act_img_w
                  );
```

**Parameters**

***Inputs***
 - `in_frame` : Mat object of input image.
 - `img_h` : Network first layer input height.
 - `img_w` : Network first layer input width.
 - `img_depth` : Number of channels in input image.
 - `act_img_h` : Input image height.
 - `act_img_w` : Input image width.
 - `data_ptr` : Buffer filled with mean subtracted output data inside `prepareInputData()` API.

***Outputs***
 - Returns the error status. Returns `0` upon successful execution or `1` otherwise.

## 7. Execute Inference

XFDNN provides `execute()` and `execute_async()` methods which support synchronous and asynchronous modes of execution on FPGA.

#### A. Synchronous Mode (Blocking Call)

**Syntax**
```c++
void XDNNScriptExecutor<float>::execute(
    const std::unordered_map <std::string, std::vector< const float*> > & input_ptrs,
    std::unordered_map< std::string, std::vector<float*> > & output_ptrs,
    int streamId
  );
```

**Parameters**

***Inputs***
 - `input_ptrs` : Reference to the map containing the input data for inference.
 - `output_ptrs` : Reference to the map which has to be filled with output data.
 - `streamId` : Network index. Use `0` in case of single network. 


#### B. Asynchronous Mode (Non-Blocking Call)

 **Syntax**
 ```c++
 void XDNNScriptExecutor<float>::execute_async(
     const std::unordered_map <std::string, std::vector< const float*> > & input_ptrs,
     std::unordered_map< std::string, std::vector<float*> > & output_ptrs,
     int streamId
   );
 ```

 **Parameters**

 ***Inputs***
 - `input_ptrs` : Reference to the map containing the input data for inference.
 - `output_ptrs` : Reference to the map which has to be filled with output data.
 - `streamId` : Network index. Use `0` in case of single network. 

#### C. Wait for results in case of Asynchronous Execution Mode

Wait for results of execution for a given PE, and a given stream.

**Syntax**
```c++
void XDNNWaitForResults(
                       void *scriptExecutor,
                       int streamId
                     );
```

***Inputs***
 - `scriptExecutor` : Instance of the class `XDNNScriptExecutor`.
 - `streamId` : Network index. Use `0` in case of single network. 


## 8. Execute Fully Connected Layers

Below are the sequence of APIs needed to execute the fully connected layers.

#### A. Load FC Layer Data

Loads fully connected layers data (weights/biases) from `model_data.h5` file generated by compiler.

**Syntax**
```c++
// create Container
std::unordered_map<int, std::vector<std::vector<float>> >  fc_wb_map;

void XDNNLoadFCWeights(
              std::unordered_map<int, std::vector<std::vector<float>> > & fc_wb_map,
              char *hdf5_file
            );
```
**Parameters**

***Inputs***
 - `hdf5_file` : Path to `model_data.h5` file generated by compiler.
 - `fc_wb_map` : Reference to the map to be filled with weights and biases of fully connected layer.

#### B. Execute

Executes the fully connected layer for given single activation or set of activations.

**Syntax**
```c++
void computeFC(
              float *weight,
              float *bias,
              float *data,
              int M, int N, int K,
              float *output
            );
```

**Parameters**

***Inputs***
 - `Weight` : Weights corresponding to the inner product layer.
 - `bias` : Biases corresponding to the inner product layer.
 - `data` : Activation or set of activations corresponding to multiple images stored as a 1D array.
 - `M` : Batch size.
 - `N` : Length of output vector.
 - `K` : Length of input vector.
 - `output` : Buffer to be filled with inner product result.

## 9. Execute Softmax

Compute the softmax score of a given activation or set of activations.

**Syntax**
```c++
void softmax(std::vector<float> &input);
```
**Parameters**
 - `input` : Referene to the vector containing activation or a set of activations corresponding to multiple images stored as a 1D Array. Same vector gets filled with softmax results.

## 10. Release Handle

Terminates the communication by destroying handle. No return value.

**Syntax**
```c++
void xblasDestroy(XBLASHandle *handle);
```

**Parameters**
- `handle` : Handle created by `xblasCreate()` API.
